/*
Criar um procedimento armazenado SP_OBTEM_RESUMO para obter valores totais de receita e
despesa para um determinado funcionário, em um Mês e Ano. O procedimento deve receber como
parâmetros de entrada o Código do Usuário, o Mês e Ano, e deve retornar como parâmetros de
saída o Total de Receitas e o Total de Despesas calculados a partir da Tabela
TB_LANCAMENTOS. Na tabela TB_LANCAMENTOS, as receitas são identificadas com R e as
despesas com D no campo TP_LANCAMENTO.*/SELECT * FROM TB_LANCAMENTOS ORDER BY TP_LANCAMENTOCREATE PROCEDURE SP_OBTEM_RESUMO(@CD_USUARIO INT, @MES INT, @ANO INT, @TOTAL_RECEITAS NUMERIC(10,2) OUTPUT,@TOTAL_DESPESAS NUMERIC(10,2) OUTPUT) AS	SET @TOTAL_RECEITAS = (SELECT SUM(VALOR) FROM TB_LANCAMENTOS WHERE ((CD_USUARIO= @CD_USUARIO AND TP_LANCAMENTO = 'R') AND (MES= @MES AND ANO = @ANO)))	SET @TOTAL_DESPESAS = (SELECT SUM(VALOR) FROM TB_LANCAMENTOS WHERE ((CD_USUARIO= @CD_USUARIO AND TP_LANCAMENTO = 'D') AND (MES= @MES AND ANO = @ANO)))	IF (@TOTAL_DESPESAS IS NULL)		BEGIN			SET @TOTAL_DESPESAS = 0		END	IF(@TOTAL_RECEITAS IS NULL)		BEGIN			SET @TOTAL_RECEITAS = 0;		END	DECLARE @TOTAL_RECEITAS NUMERIC(10,2),@TOTAL_DESPESAS NUMERIC(10,2)EXEC SP_OBTEM_RESUMO 2,05,1992,@TOTAL_RECEITAS OUTPUT,@TOTAL_DESPESAS OUTPUTPRINT @TOTAL_RECEITASPRINT @TOTAL_DESPESAS-- INSERINDO DADOS NA TABELA USUARIOINSERT INTO TB_USUARIO VALUES(1,'ALAN',123456),(2,'EDSON',120456),(3,'IURY',123756),(4,'BRENDEL',923456)-- FIM DA INSERÇÃO DE DADOS NA TABELA USUARIO-- INSERINDO DADOS NA TABELA LANÇAMENTOINSERT INTO TB_LANCAMENTOS (MES,ANO,CD_USUARIO,DESCRICAO,VALOR) VALUES(03,1992,1,'PQUENA DESCRIÇÃO',23),(04,1992,1,'PQUENA DESCRIÇÃO',214),(07,1998,1,'PQUENA DESCRIÇÃO',284),(01,2014,1,'PQUENA DESCRIÇÃO',44),(11,2015,1,'PQUENA DESCRIÇÃO',934)INSERT INTO TB_LANCAMENTOS (MES,ANO,CD_USUARIO,TP_LANCAMENTO,DESCRICAO,VALOR) VALUES(05,1992,1,'R','PQUENA DESCRIÇÃO',234),(05,1992,1,'R','PQUENA DESCRIÇÃO 3',34),(05,1992,2,'R','PQUENA DESCRIÇÃO 2',23),(05,1992,3,'R','PQUENA DESCRIÇÃO 3',34),(06,1992,1,'R','PQUENA DESCRIÇÃO',56),(07,1992,2,'R','PQUENA DESCRIÇÃO 2',89),(08,1992,3,'R','PQUENA DESCRIÇÃO 3',100),(05,1992,1,'D','PQUENA DESCRIÇÃO',90),(05,1992,2,'D','PQUENA DESCRIÇÃO 2',101),(09,1992,3,'D','PQUENA DESCRIÇÃO 3' ,58),(10,1992,1,'D','PQUENA DESCRIÇÃO',100),(06,1992,1,'D','PQUENA DESCRIÇÃO',55),(06,1992,2,'D','PQUENA DESCRIÇÃO 2',50.09),(12,1992,3,'D','PQUENA DESCRIÇÃO 3',5.90)-- FIM DA INSERÇÃO DE DADOS NA TABELA LANÇAMENTO/*Criar um procedimento armazenado SP_INCLUI_RESUMO_FINANCEIRO para incluir um resumo financeiro para um determinado Ano para todos os usuários da tabela TB_USUARIO. O procedimento deve receber como parâmetro de entrada o Ano, e incluir uma linha de resumo para todos os meses do ano para cada usuário da tabela TB_USUARIO. O procedimento deve, para cada usuário da tabela TB_USUARIO, calcular o Total de Despesas e o Total de Receitas por Mês e Ano utilizando o procedimento criado na questão 1. Todos os meses do ano devem ser incluídos no Resumo para todos os usuários, mesmo aqueles meses que não apresentem despesas e receitas.*/DROP PROCEDURE SP_INCLUI_RESUMO_FINANCEIROALTER PROCEDURE SP_INCLUI_RESUMO_FINANCEIRO (@ANO INT)ASDECLARE @CD_USUARIO INT DECLARE C_INCLUIR CURSOR FORSELECT CD_USUARIO FROM TB_USUARIODECLARE @MES INT, @TOTAL_RECEITAS NUMERIC(10,2),@TOTAL_DESPESAS NUMERIC(10,2), @ERRO INT, @ROWCOUNT INTSET @MES = 1OPEN C_INCLUIRFETCH C_INCLUIR INTO @CD_USUARIOWHILE (@@FETCH_STATUS =0)	BEGIN		WHILE(@MES<=12)			BEGIN				EXEC SP_OBTEM_RESUMO @CD_USUARIO,@MES,@ANO,@TOTAL_RECEITAS OUTPUT,@TOTAL_DESPESAS OUTPUT				INSERT INTO TB_RESUMO_FINANCEIRO VALUES(@CD_USUARIO,@MES,@ANO,@TOTAL_RECEITAS,@TOTAL_DESPESAS)				SELECT @ERRO = @@ERROR, @ROWCOUNT = @@ROWCOUNT				IF(@ERRO = 0)					BEGIN						IF(@ROWCOUNT > 0)							BEGIN								PRINT 'INFORMAÇÕES FORAM INSERIDAS'							END						ELSE							BEGIN								PRINT 'INFORMAÇÕES NÃO FORAM INSERIDAS'							END					END				ELSE					BEGIN						PRINT 'ERROR AO INSERIR DADOS'								END				SET @MES+=1			END		SELECT @MES = 1		FETCH C_INCLUIR INTO @CD_USUARIO		ENDCLOSE C_INCLUIRDEALLOCATE C_INCLUIREXEC SP_INCLUI_RESUMO_FINANCEIRO 1992EXEC SP_INCLUI_RESUMO_FINANCEIRO 2015EXEC SP_INCLUI_RESUMO_FINANCEIRO 1998EXEC SP_INCLUI_RESUMO_FINANCEIRO 2014DELETE TB_RESUMO_FINANCEIROSELECT * FROM TB_RESUMO_FINANCEIRO