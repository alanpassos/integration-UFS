CREATE TABLE TB_VENDAS_EXE12 (
	CD_VENDA INT NOT NULL IDENTITY(1,1),
	DT_VENDA DATETIME NOT NULL,
	MATRICULA INT NOT NULL,
	CD_PRODUTO INT NOT NULL,
	QUANTIDADE NUMERIC(10,2) NOT NULL 
)

INSERT INTO TB_VENDAS_EXE12 
VALUES ('2009-01-01', 10, 1001, 50.00),
		('2009-01-01', 10, 1002, 50.00),
		('2009-02-01', 10, 1001, 150.00),
		('2009-01-01', 30, 1001, 200.00),
		('2009-01-01', 30, 1001, 100.00),
		('2009-02-01', 30, 1001, 150.00),
		('2009-05-01', 40, 1002, 100.00),
		('2009-05-10', 40, 1002, 200.00),
		('2009-07-01', 40, 1001, 250.00)

CREATE TABLE TB_VENDAS_MENSAL_EXE12(
	
	MATRICULA INT NOT NULL,
	ANO INT NOT NULL,
	MES INT NOT NULL,
	MES_ATUAL NUMERIC(10,2),
	MES_ANTERIOR NUMERIC(10,2) NOT NULL,
	VARIACAO NUMERIC(6,6) NOT NULL
)

SET DATEFORMAT YMD
ALTER PROCEDURE CALCULA_VARIACAO_VENDA_EXE12 (@MATRICULA INT, @MES INT, @ANO INT, @QUANTIDADE NUMERIC(10,2),
												 @VALOR NUMERIC(10,2) OUTPUT) AS

IF (@MES = 1)
	BEGIN
		SET @MES = 13
		SET @ANO = @ANO - 1
	END
PRINT @MATRICULA
DECLARE @MATRICULA_A INT, @MES_A INT, @ANO_A INT, @QUANTIDADE_A NUMERIC(10,2), @QUANTIDADE_MES_ANTERIOR NUMERIC(10,2) = 0.0
DECLARE C_CALCULO_VENDA CURSOR FOR
SELECT V.MATRICULA, MONTH(V.DT_VENDA), YEAR(V.DT_VENDA), V.QUANTIDADE FROM TB_VENDAS_EXE12 V

OPEN C_CALCULO_VENDA
FETCH C_CALCULO_VENDA INTO @MATRICULA_A, @MES_A, @ANO_A, @QUANTIDADE_A

WHILE (@@FETCH_STATUS = 0)
	BEGIN
		IF (@MATRICULA_A = @MATRICULA AND @MES_A = (@MES - 1) AND @ANO_A = @ANO)
			BEGIN
				PRINT @MATRICULA
				PRINT @MATRICULA_A
				PRINT (@MES - 1)
				PRINT @MES_A
				PRINT @ANO
				PRINT @ANO_A
				PRINT @QUANTIDADE_MES_ANTERIOR
				SET @QUANTIDADE_MES_ANTERIOR = @QUANTIDADE_MES_ANTERIOR + @QUANTIDADE_A
				PRINT @QUANTIDADE_MES_ANTERIOR 
			END

		FETCH C_CALCULO_VENDA INTO @MATRICULA_A, @MES_A, @ANO_A, @QUANTIDADE_A
	END

IF (@QUANTIDADE_MES_ANTERIOR <> 0.0)
		--SET @VALOR = @QUANTIDADE_MES_ANTERIOR
	SET @VALOR = (@QUANTIDADE - @QUANTIDADE_MES_ANTERIOR) / @QUANTIDADE_MES_ANTERIOR
ELSE
	SET @VALOR = 0.0

CLOSE C_CALCULO_VENDA
DEALLOCATE C_CALCULO_VENDA 

DECLARE @VALOR NUMERIC(10,2)
EXEC CALCULA_VARIACAO_VENDA_EXE12 10, 02, 2009, 150, @VALOR OUTPUT
PRINT @VALOR
