INSERT INTO TB_USUARIO_EXE11 
VALUES (001, 'JOSÉ', 2512365),
		(002, 'MARIA', 1253148),
		(003, 'CARLA', 85236412),
		(004, 'CECILIA', 5421365)

INSERT INTO TB_LANCAMENTOS_EXE11 
VALUES (03, 2010, 001, 'D', 'DESCRICAO QUALQUER', 1250.0),
		(05, 2012, 001, 'D', 'DESCRICAO QUALQUER 2', 1450.0),
		(04, 2011, 002, 'D', 'DESCRICAO QUALQUER 3', 350.0),
		(09, 2011, 002, 'R', 'DESCRICAO QUALQUER 4', 1900.0),
		(08, 2013, 003, 'R', 'DESCRICAO QUALQUER 5', 8450.0),
		(12, 2014, 004, 'D', 'DESCRICAO QUALQUER 6', 150.0)


INSERT INTO TB_LANCAMENTOS_EXE11 
VALUES (03, 2010, 001, '', 'DESCRICAO QUALQUER', 5600.0),
		(05, 2012, 001, 'D', 'DESCRICAO QUALQUER 2', 1450.0),
		(04, 2011, 002, 'D', 'DESCRICAO QUALQUER 3', 350.0),
		(09, 2011, 002, 'R', 'DESCRICAO QUALQUER 4', 1900.0),
		(08, 2013, 003, 'R', 'DESCRICAO QUALQUER 5', 8450.0),
		(12, 2014, 004, 'D', 'DESCRICAO QUALQUER 6', 150.0)


ALTER PROCEDURE SP_OBTEM_RESUMO_EXE11 (@CODIGO_USUARIO INT, @MES INT, @ANO INT, 
					@DESPESAS NUMERIC(10,2) OUTPUT, @RECEITAS NUMERIC (10,2) OUTPUT) AS
SET @RECEITAS = (
					SELECT SUM(L.VALOR) FROM TB_LANCAMENTOS_EXE11 L
					WHERE (@CODIGO_USUARIO = L.CD_USUARIO AND @MES = L.MES AND @ANO = L.ANO AND 
							L.TP_LANCAMENTO = 'R')
				)
SET @DESPESAS = (
					SELECT SUM(L.VALOR) FROM TB_LANCAMENTOS_EXE11 L
					WHERE (@CODIGO_USUARIO = L.CD_USUARIO AND @MES = L.MES AND @ANO = L.ANO AND 
							L.TP_LANCAMENTO = 'D')
				)

IF (@RECEITAS IS NULL)
	SET @RECEITAS = 0
IF (@DESPESAS IS NULL)
	SET @DESPESAS = 0 

DECLARE @DESPESA NUMERIC (10,2), @RECEITAS NUMERIC(10,2)
EXEC SP_OBTEM_RESUMO_EXE11 001, 03, 2010, @DESPESA OUTPUT, @RECEITAS OUTPUT
SELECT @DESPESA AS 'DESPESAS', @RECEITAS AS 'RECEITAS'


ALTER PROCEDURE SP_INCLUI_RESUMO_FINANCEIRO_EXE11 (@ANO INT) AS
DECLARE @CD_USUARIO INT, @MES INT, @TOTAL_DESPESAS NUMERIC(10,2), @TOTAL_RECEITAS NUMERIC (10,2)
DECLARE C_INCLUI_RESUMO_FINANCEIRO_EXE11 CURSOR FOR

SELECT L.CD_USUARIO FROM TB_LANCAMENTOS_EXE11 L

OPEN C_INCLUI_RESUMO_FINANCEIRO_EXE11
FETCH C_INCLUI_RESUMO_FINANCEIRO_EXE11 INTO @CD_USUARIO

WHILE (@@FETCH_STATUS = 0)
	BEGIN
		SET @MES = 1
			WHILE (@MES <= 12)
				BEGIN
					EXEC SP_OBTEM_RESUMO_EXE11 @CD_USUARIO, @MES, @ANO, 
									@TOTAL_DESPESAS OUTPUT, @TOTAL_RECEITAS OUTPUT
					INSERT INTO TB_RESUMO_FINANCEIRO_EXE11	
					VALUES (@CD_USUARIO, @MES, @ANO, @TOTAL_RECEITAS, @TOTAL_DESPESAS)
					
					SET @MES = @MES + 1
				END
		
		FETCH C_INCLUI_RESUMO_FINANCEIRO_EXE11 INTO @CD_USUARIO
	END
CLOSE C_INCLUI_RESUMO_FINANCEIRO_EXE11
DEALLOCATE C_INCLUI_RESUMO_FINANCEIRO_EXE11

EXEC SP_INCLUI_RESUMO_FINANCEIRO_EXE11 2010

DROP TABLE _TB_RESUMO_FINANCEIRO_EXE11


SELECT CD_USUARIO AS 'USUARIO', MES, ANO, TOTAL_RECEITAS, TOTAL_DESPESAS  FROM TB_RESUMO_FINANCEIRO_EXE11
